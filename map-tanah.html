<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Map Bangun Interaktif</title>
<style>
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;touch-action:none;}
  canvas{display:block;width:100vw;height:100vh;touch-action:none;}
  #startBtn{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(255,215,0,.85);color:#000;font-weight:bold;font-size:20px;
    padding:12px 28px;border:none;border-radius:10px;cursor:pointer;z-index:10;
    box-shadow:0 0 12px gold;
  }
  #menu,#buildMenu,#houseMenu{
    position:absolute;background:rgba(20,20,20,0.95);color:#fff;
    border:2px solid gold;border-radius:10px;padding:10px;display:none;
    z-index:20;text-align:center;min-width:160px;box-shadow:0 0 12px #000;
  }
  #menu h3,#buildMenu h3,#houseMenu h3{font-size:16px;color:gold;margin:0 0 6px;}
  #menu button,#buildMenu button,#houseMenu button{
    background:gold;color:#000;font-weight:bold;border:none;border-radius:6px;
    padding:6px 12px;margin:4px;cursor:pointer;
  }
  #confirmButtons{
    position:absolute;bottom:80px;left:50%;transform:translateX(-50%);
    display:none;z-index:30;gap:20px;
  }
  #confirmButtons button{
    font-size:26px;font-weight:bold;padding:10px 20px;border:none;border-radius:12px;
    cursor:pointer;box-shadow:0 0 10px #000;
  }
  #btnYes{background:lime;color:#000;}
  #btnNo{background:red;color:#fff;}
  #hud{
    position:absolute;top:10px;left:10px;color:#fff;font-weight:bold;
    font-size:18px;z-index:40;text-shadow:1px 1px 3px #000;
  }
</style>
</head>
<body>
<canvas id="mapCanvas"></canvas>
<button id="startBtn">Mulai</button>

<!-- info populasi -->
<div id="hud">üë®‚Äçüåæ Warga: <span id="popCount">0</span></div>

<!-- menu utama bangunan -->
<div id="menu">
  <h3 id="menuTitle"></h3>
  <button id="btnBangun">Bangun</button>
</div>

<!-- menu rumah -->
<div id="houseMenu">
  <h3>üè† Rumah Warga</h3>
  <button id="btnWarga">Buat Warga Biasa</button>
</div>

<!-- menu pilihan jenis bangunan -->
<div id="buildMenu">
  <h3>Pilih Bangunan</h3>
  <button onclick="pilihBangunan('civil')">üè† Rumah Warga</button><br>
  <button onclick="pilihBangunan('stroge')">üì¶ Gudang</button><br>
  <button onclick="pilihBangunan('army')">‚öîÔ∏è Tempat Latihan</button>
</div>

<!-- tombol ceklis dan silang -->
<div id="confirmButtons">
  <button id="btnYes">‚úîÔ∏è</button>
  <button id="btnNo">‚úñÔ∏è</button>
</div>

<script>
const canvas=document.getElementById('mapCanvas');
const ctx=canvas.getContext('2d');
const btn=document.getElementById('startBtn');
const menu=document.getElementById('menu');
const menuTitle=document.getElementById('menuTitle');
const buildMenu=document.getElementById('buildMenu');
const btnBangun=document.getElementById('btnBangun');
const houseMenu=document.getElementById('houseMenu');
const btnWarga=document.getElementById('btnWarga');
const confirmBox=document.getElementById('confirmButtons');
const btnYes=document.getElementById('btnYes');
const btnNo=document.getElementById('btnNo');
const popCount=document.getElementById('popCount');

let populasi=0;
const mapImg=new Image();
mapImg.src="https://raw.githubusercontent.com/EenSelembe/Game-War-Zone/main/public/image/map.jpg";

const faction=localStorage.getItem('castleType')||'human';
const castleImg=new Image();
castleImg.src=`https://raw.githubusercontent.com/EenSelembe/Game-War-Zone/main/public/image/castile-${faction}.png`;

const world={width:1600,height:4000};
let scale=0.5;
let cameraX,cameraY;
let dragging=false,lastX=0,lastY=0,lastDist=0;
let mode="normal";
let ghostBuilding=null;
const buildings=[{type:'castile',name:'Kastil Utama',x:0,y:0,size:300,img:castleImg}];
const villagers=[];

function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;draw();}
function worldToScreen(wx,wy){return{x:(wx-cameraX)*scale+canvas.width/2,y:(wy-cameraY)*scale+canvas.height/2};}
function screenToWorld(sx,sy){return{x:(sx-canvas.width/2)/scale+cameraX,y:(sy-canvas.height/2)/scale+cameraY};}
function clampCamera(){
  const halfW=(canvas.width/2)/scale,halfH=(canvas.height/2)/scale;
  cameraX=Math.min(Math.max(cameraX,halfW),world.width-halfW);
  cameraY=Math.min(Math.max(cameraY,halfH),world.height-halfH);
}

function draw(){
  if(!mapImg.complete)return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  clampCamera();
  const mapScreen=worldToScreen(world.width/2,world.height/2);
  const mapDrawW=world.width*scale,mapDrawH=world.height*scale;
  ctx.drawImage(mapImg,mapScreen.x-mapDrawW/2,mapScreen.y-mapDrawH/2,mapDrawW,mapDrawH);
  // bangunan
  for(const b of buildings){
    if(b.img.complete){
      const s=b.size*scale;
      const p=worldToScreen(b.x,b.y);
      ctx.drawImage(b.img,p.x-s/2,p.y-s/2,s,s);
    }
  }
  // warga kecil
  for(const v of villagers){
    const p=worldToScreen(v.x,v.y);
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.arc(p.x,p.y,6,0,Math.PI*2);
    ctx.fill();
  }
  // bayangan
  if(ghostBuilding){
    const s=ghostBuilding.size*scale;
    const p=worldToScreen(ghostBuilding.x,ghostBuilding.y);
    ctx.globalAlpha=0.6;
    ctx.drawImage(ghostBuilding.img,p.x-s/2,p.y-s/2,s,s);
    ctx.globalAlpha=1;
  }
}

function showMenu(b,sx,sy){
  if(b.type==="civil"){ // kalau rumah
    houseMenu.style.left=sx-80+'px';
    houseMenu.style.top=sy-110+'px';
    houseMenu.style.display='block';
  }else{
    menuTitle.textContent=b.name;
    menu.style.left=sx-80+'px';
    menu.style.top=sy-110+'px';
    menu.style.display='block';
  }
}

function checkClick(e){
  const touch=e.touches?e.touches[0]:e;
  const rect=canvas.getBoundingClientRect();
  const x=touch.clientX-rect.left;
  const y=touch.clientY-rect.top;
  const w=screenToWorld(x,y);

  if(mode==="placing"){
    ghostBuilding.x=w.x;
    ghostBuilding.y=w.y;
    draw();return;
  }

  for(const b of buildings){
    const dx=w.x-b.x,dy=w.y-b.y;
    if(Math.hypot(dx,dy)<b.size/2){showMenu(b,x,y);return;}
  }
  menu.style.display='none';
  buildMenu.style.display='none';
  houseMenu.style.display='none';
}

// === MENU BANGUN ===
btnBangun.onclick=function(){
  menu.style.display='none';
  buildMenu.style.display='block';
  buildMenu.style.left=parseInt(menu.style.left)+'px';
  buildMenu.style.top=parseInt(menu.style.top)+'px';
};
function pilihBangunan(type){
  buildMenu.style.display='none';
  mode="placing";
  confirmBox.style.display='flex';
  const img=new Image();
  img.src=`https://raw.githubusercontent.com/EenSelembe/Game-War-Zone/main/public/image/${type}-${faction}.png`;
  ghostBuilding={type:type,name:type==="civil"?"Rumah Warga":type==="stroge"?"Gudang":"Tempat Latihan",x:cameraX,y:cameraY,size:200,img:img};
  draw();
}

// === BUAT WARGA ===
btnWarga.onclick=function(){
  houseMenu.style.display='none';
  alert("Merekrut warga...");
  setTimeout(()=>{
    const rumah=buildings.find(b=>b.type==="civil");
    const newV={x:rumah.x+Math.random()*200-100,y:rumah.y+Math.random()*200-100};
    villagers.push(newV);
    populasi++;
    popCount.textContent=populasi;
    draw();
    alert("‚úÖ 1 Warga berhasil dibuat!");
  },2000);
};

// === KONFIRMASI BANGUN ===
btnYes.onclick=function(){
  if(!ghostBuilding)return;
  let overlap=false;
  for(const b of buildings){
    const dx=b.x-ghostBuilding.x,dy=b.y-ghostBuilding.y;
    if(Math.hypot(dx,dy)<(b.size/2+ghostBuilding.size/2)){overlap=true;break;}
  }
  if(overlap){alert("Terlalu dekat dengan bangunan lain!");return;}
  buildings.push({...ghostBuilding});
  ghostBuilding=null;mode="normal";confirmBox.style.display='none';draw();
  alert("Bangunan berhasil dibangun!");
};
btnNo.onclick=function(){ghostBuilding=null;mode="normal";confirmBox.style.display='none';draw();};

// === GESTURE ===
canvas.addEventListener('touchstart',e=>{
  if(e.touches.length===1){checkClick(e);dragging=true;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;}
  else if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;lastDist=Math.hypot(dx,dy);
  }
});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===1&&dragging){
    const dx=(e.touches[0].clientX-lastX)/scale,dy=(e.touches[0].clientY-lastY)/scale;
    cameraX-=dx;cameraY-=dy;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;draw();
  }else if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.hypot(dx,dy);if(lastDist){scale*=dist/lastDist;scale=Math.max(0.4,Math.min(scale,2.5));draw();}lastDist=dist;
  }
});
canvas.addEventListener('touchend',()=>{dragging=false;lastDist=0;});

let isMouseDown=false;
canvas.addEventListener('mousedown',e=>{checkClick(e);isMouseDown=true;lastX=e.clientX;lastY=e.clientY;});
window.addEventListener('mouseup',()=>isMouseDown=false);
window.addEventListener('mousemove',e=>{
  if(!isMouseDown)return;
  const dx=(e.clientX-lastX)/scale,dy=(e.clientY-lastY)/scale;
  cameraX-=dx;cameraY-=dy;lastX=e.clientX;lastY=e.clientY;draw();
});
window.addEventListener('wheel',e=>{
  const zoom=e.deltaY<0?1.1:0.9;
  scale*=zoom;scale=Math.max(0.4,Math.min(scale,2.5));draw();
});
window.addEventListener('resize',resize);

mapImg.onload=()=>{
  const ratio=mapImg.width/mapImg.height;
  world.height=4000;world.width=world.height*ratio;
  buildings[0].x=world.width/2;buildings[0].y=world.height-300;
  cameraX=world.width/2;cameraY=world.height-800;
  resize();draw();
};
castleImg.onload=draw;
btn.addEventListener('click',()=>{
  if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}
  btn.style.display='none';draw();
});
</script>
</body>
  </html>
